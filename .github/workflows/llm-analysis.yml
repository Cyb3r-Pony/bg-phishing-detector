name: Daily LLM Analysis

on:
  schedule:
    # Run daily at 00:10 UTC (10 minutes after midnight)
    - cron: '10 0 * * *'

  # Allow manual trigger
  workflow_dispatch:

# Prevent multiple analysis runs
concurrency:
  group: llm-analysis
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run LLM analysis on high-risk domains
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          echo "ðŸ¤– Starting LLM analysis at $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          python detection/llm_analyzer.py \
            --feed-file feed/phishing_feed.json \
            --output-file feed/llm-analysis.json \
            --min-score 75 \
            --max-analyze 50
        continue-on-error: false

      - name: Check for analysis updates
        id: check_changes
        run: |
          if [[ -n $(git status -s feed/phishing_feed.json feed/llm-analysis.json) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… LLM analysis completed and added to feed"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No domains required analysis"
          fi

      - name: Commit analysis results
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name 'LLM Analysis Bot'
          git config --global user.email 'llm@bg-phishing-detector'

          # Pull latest changes
          git pull --rebase origin main || true

          git add -f feed/phishing_feed.json feed/llm-analysis.json
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          git commit -m "ðŸ¤– LLM analysis complete - $TIMESTAMP [skip ci]"

          # Push with retry logic
          for i in {1..3}; do
            if git push; then
              echo "âœ… Successfully pushed LLM analysis"
              break
            else
              if [ $i -lt 3 ]; then
                echo "âš ï¸  Push failed, retrying in 5 seconds... (attempt $i/3)"
                sleep 5
                git pull --rebase origin main || true
              else
                echo "âŒ Failed to push after 3 attempts"
                exit 1
              fi
            fi
          done

      - name: Analysis summary
        if: always()
        run: |
          echo "### ðŸ¤– LLM Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Analysis completed at:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Model:** Llama 3.3 70B Instruct (free tier)" >> $GITHUB_STEP_SUMMARY
          echo "**Threshold:** Domains with score â‰¥75" >> $GITHUB_STEP_SUMMARY
          echo "**Max domains:** 50 per run" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Count analyzed domains from llm-analysis.json
          if [[ -f feed/llm-analysis.json ]]; then
            ANALYZED=$(cat feed/llm-analysis.json | python3 -c "
import sys, json
data = json.load(sys.stdin)
print(len(data.get('analyzed_domains', [])))
            " 2>/dev/null || echo "0")

            HIGH_THREAT=$(cat feed/llm-analysis.json | python3 -c "
import sys, json
data = json.load(sys.stdin)
high = sum(1 for entry in data.get('analyzed_domains', []) if entry.get('threat_level') == 'HIGH')
print(high)
            " 2>/dev/null || echo "0")

            BLOCK_REC=$(cat feed/llm-analysis.json | python3 -c "
import sys, json
data = json.load(sys.stdin)
block = sum(1 for entry in data.get('analyzed_domains', []) if entry.get('decision') == 'BLOCK')
print(block)
            " 2>/dev/null || echo "0")

            FALSE_POS=$(cat feed/llm-analysis.json | python3 -c "
import sys, json
data = json.load(sys.stdin)
fp = sum(1 for entry in data.get('analyzed_domains', []) if entry.get('decision') == 'FALSE_POSITIVE')
print(fp)
            " 2>/dev/null || echo "0")

            echo "**ðŸ“Š Results:**" >> $GITHUB_STEP_SUMMARY
            echo "- Total domains analyzed: **$ANALYZED**" >> $GITHUB_STEP_SUMMARY
            echo "- High threat confirmed: **$HIGH_THREAT** ðŸš¨" >> $GITHUB_STEP_SUMMARY
            echo "- Block recommended: **$BLOCK_REC** ðŸ›‘" >> $GITHUB_STEP_SUMMARY
            echo "- False positives identified: **$FALSE_POS** âœ…" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Show recent high-threat domains
            echo "**ðŸš¨ Recent High-Threat Domains:**" >> $GITHUB_STEP_SUMMARY
            cat feed/llm-analysis.json | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    high_threats = [e for e in data.get('analyzed_domains', []) if e.get('threat_level') == 'HIGH']
    for entry in high_threats[-5:]:
        domain = entry.get('domain', 'N/A')
        score = entry.get('phishing_score', 0)
        confidence = entry.get('confidence', 0)
        decision = entry.get('decision', 'UNKNOWN')
        print(f\"- \`{domain}\` (score: {score}, confidence: {confidence}%, decision: {decision})\")
except:
    print('- No high-threat domains in recent analysis')
            " >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "- No high-threat domains" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸŽ¯ Purpose:** AI-powered validation of rule-based detections" >> $GITHUB_STEP_SUMMARY
