name: Hourly Phishing Scanner

on:
  schedule:
    # Run every hour at the beginning of the hour (XX:00)
    - cron: '0 * * * *'

  # Allow manual trigger for testing
  workflow_dispatch:

# Prevent multiple workflows from running simultaneously
concurrency:
  group: phishing-scanner
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 25  # Safety timeout to prevent overlaps

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run phishing scanner
        env:
          URLSCAN_API_KEY: ${{ secrets.URLSCAN_API_KEY }}
        run: |
          echo "Starting phishing scan at $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          python detection/bg-phishing-detector.py --sources urlscan
        continue-on-error: false

      - name: Check for new findings
        id: check_changes
        run: |
          if [[ -n $(git status -s feed/) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… New phishing domains detected"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No new findings this scan"
          fi

      - name: Commit and push findings
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name 'Phishing Scanner Bot'
          git config --global user.email 'scanner@bg-phishing-detector'

          # Pull latest changes to avoid conflicts
          git pull --rebase origin main || true

          git add -f feed/phishing_feed.json
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          git commit -m "ðŸš¨ Phishing scan results - $TIMESTAMP [skip ci]"

          # Push with retry logic (max 3 attempts)
          for i in {1..3}; do
            if git push; then
              echo "âœ… Successfully pushed changes"
              break
            else
              if [ $i -lt 3 ]; then
                echo "âš ï¸  Push failed, retrying in 5 seconds... (attempt $i/3)"
                sleep 5
                git pull --rebase origin main || true
              else
                echo "âŒ Failed to push after 3 attempts"
                exit 1
              fi
            fi
          done

      - name: Scan summary
        if: always()
        run: |
          echo "### ðŸš¨ Phishing Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan completed at:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Sources:** URLScan.io" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ -f feed/stats.json ]]; then
            DOMAINS=$(cat feed/stats.json | python3 -c "import sys, json; print(json.load(sys.stdin).get('domains_processed', 0))" 2>/dev/null || echo "0")
            FINDINGS=$(cat feed/stats.json | python3 -c "import sys, json; print(json.load(sys.stdin).get('new_findings', 0))" 2>/dev/null || echo "0")
            RUNTIME=$(cat feed/stats.json | python3 -c "import sys, json; print(json.load(sys.stdin).get('elapsed_time', 0))" 2>/dev/null || echo "0")

            echo "**ðŸ“Š Statistics:**" >> $GITHUB_STEP_SUMMARY
            echo "- Domains processed: **$DOMAINS**" >> $GITHUB_STEP_SUMMARY
            echo "- New phishing domains: **$FINDINGS** ðŸš¨" >> $GITHUB_STEP_SUMMARY
            echo "- Runtime: **${RUNTIME}s**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ -f feed/phishing_feed.json ]]; then
            TOTAL=$(cat feed/phishing_feed.json | python3 -c "import sys, json; print(len(json.load(sys.stdin)))" 2>/dev/null || echo "0")
            echo "**ðŸ“‹ Total threats in feed:** $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Show last 5 detections
            echo "**ðŸ” Recent Detections (last 5):**" >> $GITHUB_STEP_SUMMARY
            cat feed/phishing_feed.json | python3 -c "import sys, json; data = json.load(sys.stdin); [print(f\"- \`{e.get('domain', 'N/A')}\` (score: {e.get('score', 0)}/100) - {e.get('source', 'unknown')}\") for e in data[-5:]] if data else print('- Unable to parse recent detections')" >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "- No recent detections" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸŽ¯ Target:** Bulgarian courier services (Econt, Speedy, BulgariaPost, etc.)" >> $GITHUB_STEP_SUMMARY
